{% extends 'base.html' %}
{% load static %}

{% block css %}
  <link rel="stylesheet" href="{% static 'css/diary.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css" integrity="sha512-tS3S5qG0BlhnQROyJXvNjeEM4UpMXHrQfTGmbQ1gKmelCxlSEBUaxhRBj/EFTzpbP4RVSrpEikbmdJobCvhE3g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.theme.default.min.css" integrity="sha512-sMXtMNL1zRzolHYKEujM2AqCLUR9F2C4/05cdbxjjLSRvMQIciEPCQZo++nk7go3BtSuK9kfa/s+a4f4i5pLkw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
{% endblock css %}

{% block title %}JELLY | {{ post.title }}{% endblock title %}

{% block side %}
  {% include 'sidebar.html' with current_group=group %}
{% endblock side %}

{% block content %}
<div class="wrapper">
  <div class="content">
    <section class="header justify-between">
      <div class="flex gap-2">
        <a href="{% url 'groups:group_detail' group.pk %}" class="diary main-btn">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-10 h-10">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
          </svg>          
        </a>
        {% comment %} <a href="{% url 'diaries:index' %}" class="diary main-btn">ì´ì „ê¸€</a>
        <a href="{% url 'diaries:index' %}" class="diary main-btn">ë‹¤ìŒê¸€</a> {% endcomment %}
      </div>
    </section>
    
    <section class="post-content">
      <div class="flex justify-between items-end pb-2 px-3">
        <div>
          <div class='flex mx-4'>
            {% if post.user.image %}
              <img src="{{ post.user.image.url}}" alt="í”„ë¡œí•„" class='create-user-img'>        
            {% else %}
              <img src="{% static 'img/blank_profile_img.png' %}" alt="ê¸°ë³¸ í”„ë¡œí•„ ì´ë¯¸ì§€" class='create-user-img'>
            {% endif %}
            <h2 class="title flex items-center ms-4">{{ post }}</h2>
          </div>
          <p class="mx-4 px-3 date">{{ post.user.nickname }}</p>
          <div class='flex px-2 mt-1'>
            <p class="date mx-3">{{ post.created_string }}</p>
            <p class="date">ì¡°íšŒìˆ˜: {{ post.hits.all|length }}</p>
          </div>
        </div>
        <div class="flex gap-4">

          <form action="{% url 'groups:notice_post' group.pk post.pk %}" method="POST">
            {% csrf_token %}
            <input type="submit" value="ê³µì§€ {% if post.is_notice %}ì·¨ì†Œ{% else %}ë“±ë¡{% endif %}" class="text-sm">
          </form>
          <a href="{% url 'groups:post_update' group.pk post.pk %}" class="diary">ìˆ˜ì •</a>
          <form action="{% url 'groups:post_delete' group.pk post.pk %}" method="POST">
            {% csrf_token %}
            <input class='diary delete' onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')" type="submit" value="ì‚­ì œ">
          </form>
        </div>
            
      </div>
      <hr class="diary-hr">
      <div class="ck-content diary-detail">
        {% comment %} ì‚¬ì§„ ìºë£¨ì…€ {% endcomment %}
        <div class="px-3 owl-carousel owl-theme">
          {% for image in post.postimage_set.all %}
            <div class="img">
              <a href="#" class="image-link">
                <img src="{{ image.image.url }}" alt="ê²Œì‹œê¸€ ì´ë¯¸ì§€">
              </a>
            </div>
          {% endfor %}
        </div>
        {% comment %} í´ë¦­í–ˆì„ ë•Œ ëª¨ë‹¬ì„ ìœ„í•œ ë¶€ë¶„ {% endcomment %}
        <div class="modal-picture hidden fixed top-0 left-0 w-full h-full flex items-center justify-center bg-black bg-opacity-75 z-50">
          <div class="modal-content relative">
            <span class="close-picture absolute top-0 right-0 m-4 text-white text-3xl cursor-pointer">&times;</span>
            <img class="modal-image" src="" alt="í™•ëŒ€ ì´ë¯¸ì§€">
          </div>
        </div>
      </div>
      <div class="relative">
        <a href="#" class="top-btn">
          <svg style="color: rgb(0, 0, 0);" xmlns="http://www.w3.org/2000/svg" width="6" height="6" fill="currentColor" class="bi bi-triangle-fill" viewBox="0 0 16 16"> <path fill-rule="evenodd" d="M7.022 1.566a1.13 1.13 0 0 1 1.96 0l6.857 11.667c.457.778-.092 1.767-.98 1.767H1.144c-.889 0-1.437-.99-.98-1.767L7.022 1.566z" fill="#000000"></path> </svg>
          TOP
        </a>
      </div>

      <div class="text-lg px-5 my-2">
        {{ post.content | linebreaksbr }}
      </div>
      </section>

      {% comment %} ëŒ“ê¸€ ë¶€ë¶„ {% endcomment %}
      {% comment %} 1:ğŸ‘ 2:ğŸ¥° 3:ğŸ¤£ 4:ğŸ˜² 5:ğŸ˜­ 6:ğŸ¥³ {% endcomment %}
      <div class="post-content bottom">
        <section class="reaction">
          <div>
            <button id="dropdownRightButton" data-dropdown-toggle="dropdownRight" data-dropdown-placement="right" class="diary reaction-count" type="button">
              <svg xmlns="http://www.w3.org/2000/svg" fill="#FACA1590" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.182 15.182a4.5 4.5 0 01-6.364 0M21 12a9 9 0 11-18 0 9 9 0 0118 0zM9.75 9.75c0 .414-.168.75-.375.75S9 10.164 9 9.75 9.168 9 9.375 9s.375.336.375.75zm-.375 0h.008v.015h-.008V9.75zm5.625 0c0 .414-.168.75-.375.75s-.375-.336-.375-.75.168-.75.375-.75.375.336.375.75zm-.375 0h.008v.015h-.008V9.75z" />
              </svg>            
              <p class="emotion-total-count">{{ post.emote_users.all|length }}</p>
            </button>
            {% comment %} ê°ì •í‘œí˜„ ë“œëë‹¤ìš´ ë©”ë‰´ {% endcomment %}
            <div id="dropdownRight" class="z-10 hidden bg-white divide-y divide-gray-100 rounded-lg shadow">
              <ul class="emotion-group" aria-labelledby="dropdownDefaultButton">
                {% for emotion in emotions %}
                  <li class="emotion {% if emotion.exist %}selected-emotion{% endif %}">
                    {% if request.user.is_authenticated %}
                      {{ emotion.queryset }}
                      <form class="emotion-form" data-group-id="{{ group.pk }}" data-post-id="{{ post.pk }}" data-emotion="{{ emotion.value }}">
                        {% csrf_token %}
                        <button class="emotion-btn">
                          {% if emotion.value == 1 %}
                            <span class="emotion-emoji">ğŸ‘</span>
                          {% elif emotion.value == 2 %}
                            <span class="emotion-emoji">ğŸ¥°</span>
                          {% elif emotion.value == 3 %}
                            <span class="emotion-emoji">ğŸ¤£</span>
                          {% elif emotion.value == 4 %}
                            <span class="emotion-emoji">ğŸ˜²</span>
                          {% elif emotion.value == 5 %}
                            <span class="emotion-emoji">ğŸ˜­</span>
                          {% else %}
                            <span class="emotion-emoji">ğŸ¥³</span>
                          {% endif %}
                          <span>{{emotion.label}}</span>
                          <p class="emotion-count">{{ emotion.count }}</p>
                        </button>
                      </form>
                    {% else %}
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            </div>
          </div>
          <div class="reaction-count">
            <span>ëŒ“ê¸€</span>
            <span>{{ comments|length }}</span>
          </div>
        </section>
    
        <section>
          <div>
            {% comment %} ëŒ“ê¸€ ì‘ì„± ì¹¸ {% endcomment %}
            <form action="{% url 'groups:comment_create' group.pk post.pk %}" method="POST" class="comment-form">
              {% csrf_token %}
              {{ comment_form }}
              <input type="submit" value="ì‘ì„±" class="comment main-btn">
            </form>
          </div>
          {% comment %} ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ {% endcomment %}
          <div class="comment-wrapper">
            {% if comments %}
              {% for comment in comments %}
                <div class="comment-area" data-comment-id="{{ comment.pk }}" data-group-id="{{ group.pk }}" data-post-id="{{ post.pk }}">
                  <div class="comment-content">
                    <div class="flex gap-3">
                      <div class="create-user-img">
                        {% if comment.user.image %}
                          <img src="{{ comment.user.image.url }}" alt="">
                        {% else %}
                          <img src="{% static 'img/blank_profile_img.png' %}" alt="">
                        {% endif %}
                      </div>
                      <div>
                        <p class="comment-user">{{ comment.user.nickname }}</p>
                        <p class="comment-comment">{{ comment.content }}</p>
                      </div>
                    </div>
                    <form id="comment-update-form" class="hidden comment-form">
                      {% csrf_token %}
                      {{ comment_form }}
                      <input type="submit" value="ìˆ˜ì •" class="comment main-btn">
                    </form>
                    <div class="date comment-bottom">
                      <div class="comment-bottom-item">
                        <p>{{ comment.created_at }}</p>
                        <form class="comment-like-form">
                          {% csrf_token %}
                          <button type="submit" class="comment-like-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="{% if request.user in comment.like_users.all %}#E02424{% else %}none{% endif %}" viewBox="0 0 24 24" stroke-width="1.5" stroke="#E02424" class="w-4 h-4">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" />
                            </svg>
                            <span>{{ comment.like_users.count }}</span>
                          </button>
                        </form>
                      </div>
                      <div class="comment-bottom-item">
                        {% if comment.user == request.user %}
                          <button class="comment-update-btn">ëŒ“ê¸€ ìˆ˜ì •</button>
                          <form action="{% url 'groups:comment_delete' group.pk post.pk comment.pk %}" method="POST">
                            {% csrf_token %}
                            <input type="submit" value="ëŒ“ê¸€ì‚­ì œ" class="delete" onclick="return confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">
                          </form>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>
                <hr class="comment-hr">
              {% endfor %}
            {% else %}
              <div class="no-comment">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" class="w-12 h-12">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" />
                </svg>
                <h3>ì‘ì„±ëœ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</h3>
              </div>
            {% endif %}
          </div>
        </section>
      </div>
  </div>
</div>

{% if messages %}
  {% for message in messages %}
    <script>alert('{{ message }}')</script>
  {% endfor %}
{% endif %}

{% endblock content %}

{% block script %}
<script src="{% static 'js/post_detail.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js" integrity="sha512-pumBsjNRGGqkPzKHndZMaAG+bir374sORyzM3uulLV14lN5LyykqNk8eEeUlUkB3U0M4FApyaHraT65ihJhDpQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js" integrity="sha512-bPs7Ae6pVvhOSiIcyUClR7/q2OAsRiovw4vAkX+zJbw3ShAeeqezq50RIIcIURq7Oa20rW2n2q+fyXBNcU9lrw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script type="text/javascript">
  $('.owl-carousel').owlCarousel({
      loop:false,
      margin:10,
      nav:false,
      responsive:{
          0:{
              items:1,
              slideBy:4,
              rows:2,
          },
          600:{
              items:2,
              slideBy:8,
              rows:2,
          },
          1000:{
              items:4,
              slideBy:12,
              rows:2,
          },
      }
  })
</script>

<script type="text/javascript">
  // ëª¨ë‹¬ ì—´ê¸°
  $('.img').on('click', function() {
    var imageUrl = $(this).find('img').attr('src');
    $('.modal-picture').removeClass('hidden');
    $('.modal-image').attr('src', imageUrl);
  });

  // ëª¨ë‹¬ ë‹«ê¸°
  $('.modal-picture').on('click', function(event) {
    // ëª¨ë‹¬ ë‚´ë¶€ë¥¼ í´ë¦­í•œ ê²½ìš°ì—ëŠ” ëª¨ë‹¬ì´ ë‹«íˆì§€ ì•Šë„ë¡ ì´ë²¤íŠ¸ ì „íŒŒ ì¤‘ë‹¨
    if ($(event.target).hasClass('modal-content')) {
      return;
    }
    $('.modal-picture').addClass('hidden');
    $('.modal-image').attr('src', '');
  });

  // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $('.close-picture').on('click', function() {
    $('.modal-picture').addClass('hidden');
    $('.modal-image').attr('src', '');
  });
</script>
{% endblock script %}